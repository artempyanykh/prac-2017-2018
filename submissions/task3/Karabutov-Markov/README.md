# Задание №3
## Краткое описание задания

### Условие
**Applepen** -- это большая торговая сеть, которая занимается продажей всего двух продуктов: **яблок** и **карандашей**.
Ее магазины расположены в различных уголках Соединенных Штатов и более 10 лет обслуживают покупателей.

Недавно топ-менеджмент компании решил более активно использовать имеющиеся у них данные в принятии решений.
Каждый магазин собирает информацию о:

1. закупках (поставки яблок и карандашей два раза в месяц),
2. продажах (лог транзакций, по записи на каждую проданную позицию),
3. инвентарь (месячные данные общего количества яблок и карандашей на складе).

Данные доступны в формате CSV.
Внутри файла данные отсортированы по дате.

К сожалению, данные никогда не консолидировались и не проверялись.
Нам необходимо получить следующие данные в CSV-файлах.


#### 1. Состояние склада на каждый день
Данные о состоянии склада в конце каждого дня после того как все поставки и продажы были совершены.
Подобная информация будет очень ценна менеджерам магазинов.
Состояние склада должно строится на основне месячных данных об инвентаре.
Известно, что люди воруют из магазинов, но сейчас нет никакой возможности узнать объем сворованного товара.

Данные должны быть в следующем виде:

|date|apple|pen|
|---|---|---|
|2006-01-01|14105|770|
|...|||

#### 2. Месячные данные о количестве сворованного товара

Данные должны быть в следующем виде:

|date|apple|pen|
|---|---|---|
|2006-01-31|4|4|
|2006-02-28|5|0|
|...|||


#### 3. Агрегированные данные об объемах продаж и количестве сворованной продукции по штату и году

Данные должны быть в следующем виде:

|year|state|apple_sold|apple_stolen|pen_sold|pen_stolen|
|---|---|---|---|---|---|
|2006|AK|4|2|2|1
|2007|AL|5|0|6|2|
|...||||||


## Подход к решению

### Исходные данные
Для начала разберем алгоритм именования файла:

```[штат]-[id магазина]-[тип информации].csv ```

Где тип информации может быть одной из трех строк:

+ **inventory** --- информация о инвентаризации склада.
+ **sell** --- информация о продажах продукции.
+ **supply** --- информация о поставках продукции.

К примеру имя файла `MS-s5-inventory.csv` говорит, что:

1. Магазин из штата --- **MS**.
2. Название id магазина --- **s5**.
3. В файле находится информации об инветаризации склада.

Разберём структуру файлов подробнее.

#### 1. Информация о инвентаризации склада. 
Файл имеет следующий вид:

|date|apple|pen|
|---|---|---|
|2006-01-31|3241|327|
|2006-02-28|6476|723|
|2006-03-31|9598|1072|
|...|...|...|

Первый столбец (**date**) --- это дата инвертаризации.
Второй столбец (**apple**) --- это количество яблок на складе.
Третий столбец (**pen**) --- это количество карандашей на складе.

#### 2. Информация о продажах продукции
Файл имеет следующий вид:

|date|sku_num|
|---|---|
|2006-01-01|MS-s5-ap-7d784729-e45e-4e29-b55a-445cbd94662c|
|2006-01-01|MS-s5-ap-e629140a-5ee4-4d07-b24b-97433fdb99a6|
|2006-01-01|MS-s5-ap-92e2581d-4466-410f-aa85-94fcdbcab7a9|
|...|...|

Первый столбец (**date**) --- это дата транзакции (продажи).
Второй столбец (**sku_num**) --- информация о транзакции.

Строка с информацией о транзакции имеет следующий вид:

```[штат]-[id магазина]-[тип продукта]-[id транзакции]```

Где тип продукта может быть одной из двух строк:

+ **ap** --- транзакция по продаже яблок.
+ **pe** --- транзакция по продаже карандашей.

К примеру транзакция `MS-s5-ap-6c1c9152-c5c8-4569-a36f-e58dbb3baf74` говорит, что:

1. Яблоко было продано в штате **MS**.
2. Яблоко было продано в магазине **s5**.
3. Идетификатор транзакции --- **6c1c9152-c5c8-4569-a36f-e58dbb3baf74**.

#### 3. Информация о поставках продукции
Файл имеет следующий вид:

|date|apple|pen|
|---|---|---|
|2006-01-01|3041|313|
|2006-01-15|2973|330|
2006-02-01|2947|341|
|...|...|...|

Первый столбец (**date**) --- это дата поставки.
Второй столбец (**apple**) --- это количество поставленных яблок.
Третий столбец (**pen**) --- это количество поставленных карандашей.

### Реализация
#### Алгоритм решения пункта задания 1 и 2
Для выполнения заданий описанных в пункте 1 и 2 (получение состояния скалада на каждый день и количества сворованного товара каждый месяц) была написана функция `calculation`, которая решала задачу из 1 и 2 пункта для конкретного магазина (потом эта функция запускалась для каждого магазина).

Алгоритм работы этой функции следующий:
1. Считываем входные данные для магазина (поставки, продажи, инвентаризации).
2. Определяем целевые года.
3. В цикле по дням (от 1 января самого раннего года до 31 декабря самого позднего года) делаем следующие шаги:

   1.    Обрабатываем продажи за этот день.
   2.    Если в этот день были поставки, то их тоже обрабатываем.
   3.    Выводим информация о состоянии скалада на текущий день.
   4.    Если наступил конец месяца, то обрабатываем инвентаризации в этот день и выводим информацию о количестве сворованного товара.

#### Алгоритм решения пункта задания 3
Для выполнения пункта 3 была написана функция `count_total_data`, которая считает агрегированные данные для всех магазинов по штатам и годам и выводит их в отдельный файл total_data.csv.

Алгоритм этой функции следующий:
1. Создаем пустую итоговую таблицу total_data формата DataFrame
2. В цикле по магазинам (которые подаются на вход):
    1.   Считаем проданные товары (apple и pen) для одного магазина по годам
    2.   Считаем украденные товары для одного магазина по годам
    3.   Если штат новый - объеденяем данные о проданном и украденном в одну новую таблицу и переименовываем столбцы в 'state','apple_sold','apple_stolen','pen_sold','pen_stolen'. 
    4.   Если штат прежний - объеденяем данные о проданном и украденном в одну таблицу и складываем полученные данные с предыдущими для этого штата.
    5.   Для каждого штата заносим данные в итоговую таблицу total_data
3. Выводим на экран полученную итоговую таблицу и записываем ее в csv-файл total_data.csv.


### Методы и функции
В данном разделе опишем некоторые методы и функции, которые были использованы в ходе выполнения работы.

#### Модуль OS
* Функция `os.listdir(path)` --- получение списка файлов и директорий в папке `path`.

#### Модуль Numpy
* Функция `unique(lst)` --- получение уникальных значений списка `lst`.
* Функция `sort(lst)` --- получение отсортированного списка `lst`.

#### Модуль Time
* Функция `time()` --- получения количества секунд с начала эпохи.



### Модуль Pandas
* Функция `read_csv(path)` --- получение объекта `DataFrame` с данными из файла расположенному по пути `path` и имеющему расширение `csv`.
* Конструктор `Timestamp(str)` --- получение объекта типа `Timestamp` (объект для представление времени) из строки `str`.
* Конструктор `DateOffset(day)` --- получение объекта типа `DateOffset` со смещением в `day` дней.
* Метод `DataFrame.iterrows()` --- получение итератора по строкам `DataFrame`.
* Метод `Timestamp.strftime(str)` --- получение строкого представление времени по форматику заданному строкой `str`.


## Необходимое ПО

### Библиотеки языка Python
* **Pandas** - для извлечения данных из файлов `csv` и их обработка.
* **Numpy** - для обработки массивов.
* **Time** - для измерения времени работы блоков кода.
* **Os** - для получения информации из операционной системы.


### Программы
* Python 3.6
* Jupeter Notebook

## Авторы

**Марков Игорь, 312 группа** 

**Карабутов Дмитрий, 312 группа** 



