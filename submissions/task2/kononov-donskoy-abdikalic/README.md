Заданиe
1) Ситать данные из training.csv. Ответы на тестовой выборке testing.csv не следует использовать ни в каких экспериментах, кроме финального. Проверить является ли ряд стационарным в широком смысле. Это можно сделать двумя способами:
	а) Провести визуальную оценку, отрисовав ряд и скользящую статистику(среднее, 	стандартное 	отклонение). Постройте график на котором будет отображен сам ряд и 	различные 	скользящие статистики.
	б) Провести тест Дики - Фуллера.
Сделать выводы из полученных результатов. Оценить достоверность статистики. 
2)Разложить временной ряд на тренд, сезональность, остаток в соответствии с аддитивной, мультипликативной моделями. Визуализировать их, оценить стационарность получившихся рядов, сделать выводы. (15 баллов)
3)Проверить является ли временной ряд интегрированным порядка k. Если является, применить к нему модель ARIMA, подобрав необходимые параметры с помощью функции автокорреляции и функции частичной автокорреляции. Выбор параметров обосновать. Отобрать несколько моделей. Предсказать значения для тестовой выборки. Визуализировать их, посчитать r2 score для каждой из моделей. Произвести отбор наилучшей модели с помощью информационного критерия Акаике. Провести анализ получившихся результатов. (50 баллов)
За все правильно выполненные пункты можно получить 90 баллов.
Подход к решению
Временной ряд - последовательно измеренные через некоторые (зачастую равные) промежутки времени данные.
Параметры временного ряда:
1. Период времени
2. Уровни ряда - значения показателя
Случайным процессом y(t), заданным на множестве T, называют функцию от t, значения которой при каждом t ∈T являются случайной величиной.
Математическое ожидание случайного процесса y(t) — это функция m(t), такая, что для каждого t значение функции m(t) является математическим ожиданием случайной величины y(t):
 m(t) = M [y(t)]
Ковариационная функция случайного процесса y(t) — это функция: 
C(t,s) = cov[y(t), y(s)] = M[(y(t) − m(t))× (y(s) − m(s))]
Значение ковариационной функции при t = s задает дисперсию случайного процесса:
 Dy(t) = cov[y(t), y(t)]
Квадратный корень из Dy(t) называют стандартным отклонением случайного процесса: 
σ (t) = (cov[y(t), y(t)] )1/2
Корреляционная функция случайного процесса y(t) — это величина 
corr(y(t), y(s)) = cov[y(t), y(s)] /[σ(t)σ(s)]
Последовательности случайных величин называются стационарными , если их вероятностные свойства не изменяются во времени.
Случайный процесс y(t) называют строго стационарным (или стационарным в узком смысле), если для любых n, t1,t2,...,tn  и τ распределения случайных величин {y(t1), y(t2),..., y(tn)} и {y(t1 +τ ), y(t2 +τ ),..., y(tn +τ )} одинаковы. 
Это означает, что функции конечномерных распределений не меняются при сдвиге времени.
Отсюда следует, что у стационарного процессафункции m(t), σ (t) постоянны, а ковариационная функция и корреляционная функция зависят от s − t . 
Автоковариационной функцией стационарного процесса y(t) называют функцию:
 γ (k) = cov[y(t), y(t + k)]
Автокорреляционной функцией стационарного процесса y(t) называют функцию:
  r(k) = corr[y(t), y(t + k)]
где k > 0 — целое число. 
Величина k называется лагом, указывает расстояние между членами временного ряда, для которых вычисляется коэффициент корреляции. Коэффициент корреляции r(k) измеряет корреляцию, существующую между членами одного и того же ряда, поэтому его принято называть коэффициентом автокорреляции. 
Частная автокорреляционная функция rчаст(k) показывает aвтокорреляцию, существующую между разделенными k тактами времени членами временного ряда y(t) и y(t + k ), при устраненном опосредованном влиянии на эту взаимозависимость всех промежу-точных
 rчаст(k) = -R0k/(R00Rkk)1/2
Rij – алгебраическое дополнение к rij = r(|i-j|)

Временной ряд y называется стационарным, если E[y] = Const, D[y] = Const, Corr[yk, y(k-1)] = Const * k - т.е если эти параметры не зависят от времени. Другое определение стационарности - это отсутствие тренда.

Трендом временного ряда называется изменение, определяющее общее направление развития, т.е. грубо говоря общее направление графика ряда (возрастает/убывает/не изменяется)
Визуальная оценка ряда на стационарность заключается в том, что исходя из графика делается предположение о том, имеет ли ряда тренд или нет

Скользящая средняя (Moving Average - MA) - среднее арифметическое значений исходной функции за установленный период.

Сглаживает краткосрочные колебания и помогает выделить основные тенденци.Скользящая средняя является фильтром низких частот, то есть пропускает низкочастотную активность (долгосрочные циклы и их линии трендов), отсекая высокочастотные — случайные колебания
Простое скользящее среднее (simple moving average) численно равно среднему арифметическому значений исходной функции за установленный период.

Стандартное отклонение - показывает, на сколько в среднем отклонился ряд от средней вариации ряда (от среднего арифметического, в нашем случае).

Скользящая средняя вместе со стандартным отклонением составляют скользящие статистики.

Тест Дики-Фуллера используется для проверки ряда на стационарность. Он проверяет ряд на наличие единичных корней.

Временной ряд имеет единичный корень (хотя бы один), если его первые разности образуют стационарный ряд. Обозн. y(t) ~ I(1)
Δy(t)=y(t)-y(t-1)  -  Δ - разностный оператор
I(j) - означает, что ряд является интегрированным порядка j, I(0) - ряд стационарен.
Авторегрессионное уравнение 1-го порядка AR(1):
y(t) = a * y(t-1) + e(t) , где e(t) – ошибка
Тест Дики-Фуллера проверяет значение коэффициента а 
а = 1  есть еденичные корни — нет стационарности, ряд интегрированный порядка 1
|а| < 1 нет единичных корней — ряд стационарен
|а| > 1 требуется более точный анализ
Если преобразовать уравнение
y(t) = a * y(t-1) + e(t) =>  Δy(t) = (a-1) * y(t-1) + e(t) =>  Δy(t) = b * y(t-1) + e(t), где b = a – 1
Основная гипотеза: H0: b = 0 процесс не стационарен
Конкурирующая гипотеза: H1: b < 0  процесс стационарен
Проверка на стационарность тестом Дики-Фуллера происходит с помощью сравнения результата функции adfuller():
p-value – достоверность статистики с critical-value – критическим значением уровня 5%.
p-value > critical-value еденичный корень есть
p-value <= critical-value еденичный кореня нет
Достоверность статистики p-value – мера уверенности в истинности результата. Чем p-value меньше, тем достовернее статистика. Если достоверность больше критического параметра critical-value, то статистика не достоверная и единичныее корни есть.
Уровень значимости статистического теста — допустимая для данной задачи вероятность ошибки первого рода (ложноположительного решения, false positive), то есть вероятность отклонить нулевую гипотезу, когда на самом деле она верна.
Тренд, Сезональность, Остаток. Модели.
Трендом временного ряда называется изменение, определяющее общее направление развития, т.е. грубо говоря общее направление графика ряда (возрастает/убывает/не изменяется). Плавно меняющаяся компонента, описывающая  Обозначение: Т.
Сезональностью временного ряда называют переодические колебания, наблюдаемые во временных рядах. Обозначение: S.
Описывает чистое влияние долговременных факторов
Сезонная компонента — отражающая повторяемость экономических процессов в течение не очень длительного периода
Циклическая компонента — отражающая повторяемость экономических процессов в течение длительных периодов 

Остатком временного ряда называется разница между предсказынным по модели и наблюдаемым значением.  Случайная компонента, отражающая влияние не подающихся учету и регистрации случайных факторов. Обозначение: E.
Выбор аддитивной или мультипликативной модели осуществляется на основе анализа структуры колебаний. Если амплитуда колебаний приблизительно постоянна, строят аддитивную модель временного ряда. Если амплитуда колебаний приблизительно возрастает или уменьшается, строят мультипликативную модель временного ряда. 
Аддитивная модель TS = T + S + E
Мультипликативная модель TS = T * S * E.
Аддитивная модель
Сезональность = Временной ряд — центрированное скользящее среднее
центрированное скользящее среднее (ВР) = скользящее среднее( скользящее среднее(ВР))
Одним из наиболее распространенных способов моделирования тенденции временного ряда (тренда) является построение аналитической функции, характеризующей зависимость уровней ряда y от времени t: 
y(t) = f (t, β )+ ε t ,
где f (⋅) — функция тренда (она обычно полагается гладкой), β — неизвестные параметры модели (их необходимо оценить), t — время (рассматривается как независимая переменная), εt — независимые и одинаково распределенные случайные величины (распределение полагается нормальным). Для построения трендов чаще всего применяются следующие функции: 
• линейный тренд f (t,β ) = β0 + β1t ; 
• гипербола f (t,β ) = β0 + β1/t ; 
• экспоненциальный тренд f (t,β ) = β0eβ1t ; 
• тренд в форме степенной функции f (t,β ) = β0tβ1 ; 
• полином второго и более высоких порядков f (t, β ) = β 0 + β1t + β 2t2 + ... + β m tm . 
Параметры каждого из перечисленных трендов можно определить обычным методом наименьших квадратов (МНК)
Остаток = ВР - Сезональность - Тренд
Мултипликативная модель
Сезональность = Временной ряд /  Центрированные скользящее среднее
Тренд находится приближением временного ряда с помощью метода наименньших квадратов.
Остаток = ВР / (Сезональность * Тренд)
Инетгрированный временной ряд — нестационарный временной ряд, разности некоторого порядка от корторого являются стацинарным временным рядом.
Временной ряд является интегрированным порядка k, если разности k порядка временного ряда являются стационарным рядом, а никакие разности меньшего порядка не являются стационарным рядом.
Δy(t) = y(t+1) – y(t) – разностный оператор
Δmy(t) = ym-1(t+1) – ym-1(t)
Обозначение: y~I(k) интегрированный временной ряд порядка k
Модель ARIMA (autoregressive integrated moving average) — интегрированная модель авторегрессии — скользящего среднего — модель и методология анализа временных рядов. Является расширением моделей ARMA для нестационарных временных рядов, которые можно сделать стационарными взятием разностей некоторого порядка от исходного временного ряда ). Модель ARIMA(p,d,q) означает, что разности временного ряда порядка d подчиняются модели ARMA(p,q).
Авторегрессионная (AR) модель (autoregressive model) — модель временных рядов, в которой значения временного ряда в данный момент линейно зависят от предыдущих значений этого же ряда. Авторегрессионный процесс порядка p (AR(p)-процесс) определяется следующим образом
X(t) = c + sum(aiXt-i , from i=1 to p) +et
где a1,…,ap – параметры модели (коэффициенты авторегрессии), с — постоянная, et - шум
Модель скользящего среднего q-го порядка MA(q) — модель временного ряда вида:  
Xt = sum(bjet-j , from j =0 to q)
где et — белый шум, bj — параметры модели 
Модель авторегрессии — скользящего среднего ARMA(autoregressive moving-average model) — одна из математических моделей, использующихся для анализа и прогнозирования стационарных временных рядов в статистике. Модель ARMA обобщает две более простые модели временных рядов — модель авторегрессии (AR) и модель скользящего среднего (MA).
ARMA(p ,q) = AR(p) + MA(q)
R^2 (коэффициент определенности) функция регрессии. Доля дисперсии зависимой переменной объясняемая рассматриваемой можелью. Наилучшее значение 1.0 и оно может быть отрицательным( т. к. можель может быть достаточно плохой). Постоянная модель которая всегда предсказывает ожидаемое значение y несмотря на входные данные будет иметь R^2 score равный 0.

AIC - Критерий используется для сравнения моделей с разным числом параметров, когда требуется выбрать наилучший набор объясняющих переменных.Считается, что наилучшей будет модель с наименьшим значением критерия AIC. Стоит отметить, что абсолютное значение AIC не имеет смысла — он указывает только на относительный порядок сравниваемых моделей.
AIC = 2k – 2ln(L)
где k - число параметров модели, L – максимизированные значение функции правдоподобия модели.

Реализация
1. Cчитываем данные из файла “training.csv”
pd.read_csv('training.csv', parse_dates = ['Date'], index_col = 'Date')

Вычисляем среднее значение ряда

ts.rolling(window = 15).mean()

Вычисляем стандартное отклонение

ts.rolling(window = 15).std()

Строим в одних координатных осях график исходного временного ряда, среднего значения и стандартного отклонения. Визуально оцениваем стационарность ряда.
Ряд является стационарным, если E[y] = Const, D[y] = Const, Corr[yk, y(k-1)] = Const * k - т.е если эти параметры не зависят от времени. 
Тест Дики – Фуллера. Вызывается с помощью функции DF() , которая возвращает булевскре значение 
test = st.adfuller(data.Value)
test[0] > test[4]['5%']

С помощью теста Дики – Фуллера проверяем наличие единичных корней. Для того, чтобы знать есть ли у нас единичные корни сравниваем достоверность статистики p-value с критическими значениями значимости 5% - critical_values[‘5%’]. То есть, если:	
test[0]> test[4][‘5%’], то есть единичные корни, а следовательно, ряд не стационарен
test[0] <= test[4][‘5%’], то единичные корни отсутствуют и ряд стационарен

2. Раскладываем временной ряд на на тренд, сезональность и остаток в соответсвии с аддитивной и мультипликативной моделями

seas.seasonal_decompose(ts, model = dtype)

Строим общий график. Строим графики сезонной составляющей, тренда и шума по отдельности и проводим для них тест Дики-Фуллера DF(data). Для этого вводим функцию.

Chart(title, data)

3. Находим порядок интегрированности ряда, т.е. дифференциируем пока результат будет являться стационраным рядом.

tmp.diff().dropna()

Проверку на стационарность делаем с помощью теста Дики-Фуллера

DF(tmp)

Ряд является интегрированным 1 порядка, нашли параметр d для модели ARIMA.
Находим функции автокорелляции и частичной автокорелляции для исходного ряда и отрисовываем их

acf(ts, nlags=20)
pacf(ts, nlags=20, method='ols')
По диаграммам можно найти параметры для ARIMA модели p и q. Q – номера коэффициентов сильно отличных от нуля (ACF график). P – наибольший номер коэффициента сильно отличного от нуля (PACF график).
Строим ARIMA модель с найденными параметрами p, d ,q

ARIMA(ts, order = (p, d ,q))

Тренируем модель
model.fit()
Делаем прогноз согласно модели

model.predict(start='1989-01-01', end='1993-12-01', typ='levels', dynamic=True)

Отрисовываем график и сравниваем значения прогноза и реальных данных
test_ts = pd.read_csv('testing.csv', parse_dates = ['Date'], index_col = 'Date')
Считаем R2 score и критерий Акаике
r2_score(test_ts, forecast) model.aic 
Лучшая модель имела параметры

p = 1, q = 1, d = 1 

И имела следующие результаты тестов

R2 score: -3
AIC: 248
Используемые библиотеки
pandas – библиотека Python для анализа данных
pandas.read_csv(filepath_or_buffer,  index_col, parse_dates) – необходим для считывания данных из csv – файла и преобразования этих в DatаFrame
pandas.DateFrame.plot(ax) – строит график DataFrame с помощью matplotlib или pylab
pandas.DateFrame.rolling(window).mean – считает скользящее среднее
pandas.DateFrame.rolling(window).std – считает стандартное отклонение 
statsmodels – модуль, предоставляющий широкий набор средств и методов для проведения статистического анализа и эконометрики
statsmodels.tsa.stattools.adfuller(x) – тест Дики – Фуллера, проверяющий наличие единичных корней у ряда
statsmodels.tsa.seasonal.seasonal_decompose(x, model='additive') — разложение ряда на составляющие
statsmodels.tsa.stattools.acf(x, nlags=40) — функция автокорелляции
statsmodels.tsa.stattools.pacf(x, nlags=40, method='ywunbiased') — функция частичной автокорелляции
statsmodels.tsa.arima_model.ARIMA(endog, order) — создание ARIMA модели
scikit-learn — библиотека машинного обучения 
sklearn.metrics.r2_score(y_true, y_pred) — считает r2 score
Numpy - математика
numpy.diff(a, n=1, axis=-1)  - дифференцирует ряд
matplotlib – для построения диаграммы
matplotlib.pyplot.bar(x, height) – рисует диаграмму 
matplotlib.pyplot.xlabel(s) – записывает строку s на оси х
matplotlib.pyplot.ylabel(s) - записывает строку s на оси y
matplotlib.pyplot.title(s) – записывает строку s в оглавлении
matplotlib.pyplot.show() – выводит на дисплей все рисунки
Инструкции по запуску
Необходимое ПО
Jupyter
Python 3.6
Установленные библиотеки
Запуск(из окна терминала)
Из директории проекта:
jupyter-notebook task1.ipynb
В jupyter:
Cell > Run All
Участники
Абдыкалик Чингиз — 1 часть задания + readme
Донской Иван — 2 часть задания + readme
Кононов Сергей — 3 часть + readme
